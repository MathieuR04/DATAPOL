"0","library(dplyr)"
"0","library(stringi)"
"0","library(tidyr)"
"0","library(purrr)"
"0","library(sf)"
"0","library(leaflet)"
"0","library(RColorBrewer)"
"0",""
"0","# 1. Load CSV"
"0","data <- read.csv(""/Users/mathieurojas/Documents/Electoral Data/Chile_Effective_Number_of_Parties/Chile_Presidenciales_Final.csv"")"
"0",""
"0","# 2. Clean and reshape"
"0","replacements <- c("
"0","  ""CABO DE HORNOS(EX-NAVARINO)"" = ""CABO DE HORNOS"","
"0","  ""AISEN"" = ""AYSEN"","
"0","  ""LLAY-LLAY"" = ""LLAILLAY"","
"0","  ""TREHUACO"" = ""TREGUACO"""
"0",")"
"0",""
"0","data <- data %>%"
"0","  filter(Unit == ""Municipality"") %>%"
"0","  mutate("
"0","    Unit_ID = stri_trans_general(Unit_ID, ""Latin-ASCII""),"
"0","    Unit_ID = recode(Unit_ID, !!!replacements)"
"0","  ) %>%"
"0","  pivot_wider("
"0","    id_cols = Unit_ID,"
"0","    names_from = Year,"
"0","    values_from = ENP,"
"0","    names_prefix = ""ENP_"""
"0","  )"
"0",""
"0","# 3. Load geojson"
"0","urls <- paste0(""https://raw.githubusercontent.com/caracena/chile-geojson/master/"", 1:16, "".geojson"")"
"0","geojson <- urls %>% map(st_read, quiet = TRUE) %>% bind_rows()"
"0",""
"0","geojson <- geojson %>%"
"0","  mutate("
"0","    Comuna = stri_trans_general(Comuna, ""Latin-ASCII"") %>% toupper()"
"0","  )"
"0",""
"0","# 4. Join data"
"0","Comunas_ENP <- geojson %>% left_join(data, by = c(""Comuna"" = ""Unit_ID""))"
"0",""
"0","# 5. Ensure numeric"
"0","Comunas_ENP$ENP_2021 <- as.numeric(Comunas_ENP$ENP_2021)"
"0","Comunas_ENP$ENP_2017 <- as.numeric(Comunas_ENP$ENP_2017)"
"0","Comunas_ENP$ENP_2013 <- as.numeric(Comunas_ENP$ENP_2013)"
"0",""
"0","# 6. Palette"
"0","pal <- colorNumeric(""YlOrRd"", domain = c(Comunas_ENP$ENP_2013, Comunas_ENP$ENP_2017, Comunas_ENP$ENP_2021))"
"0",""
"0","# 7. Leaflet map with layers"
"0","leaflet(Comunas_ENP) %>%"
"0","  addProviderTiles(providers$CartoDB.Positron) %>%"
"0","  "
"0","  addPolygons("
"0","    fillColor   = ~pal(ENP_2021),"
"0","    color       = ""white"","
"0","    weight      = 0.3,"
"0","    fillOpacity = 0.8,"
"0","    popup       = ~paste0(""<b>"", Comuna, ""</b><br/>ENP 2021: "", ENP_2021),"
"0","    group       = ""ENP 2021"""
"0","  ) %>%"
"0","  "
"0","  addPolygons("
"0","    fillColor   = ~pal(ENP_2017),"
"0","    color       = ""white"","
"0","    weight      = 0.3,"
"0","    fillOpacity = 0.8,"
"0","    popup       = ~paste0(""<b>"", Comuna, ""</b><br/>ENP 2017: "", ENP_2017),"
"0","    group       = ""ENP 2017"""
"0","  ) %>%"
"0","  "
"0","  addPolygons("
"0","    fillColor   = ~pal(ENP_2013),"
"0","    color       = ""white"","
"0","    weight      = 0.3,"
"0","    fillOpacity = 0.8,"
"0","    popup       = ~paste0(""<b>"", Comuna, ""</b><br/>ENP 2013: "", ENP_2013),"
"0","    group       = ""ENP 2013"""
"0","  ) %>%"
"0","  "
"0","  addLayersControl("
"0","    baseGroups = c(""ENP 2021"", ""ENP 2017"", ""ENP 2013""),"
"0","    options = layersControlOptions(collapsed = FALSE)"
"0","  ) %>%"
"0","  "
"0","  addLegend("
"0","    ""bottomright"","
"0","    pal    = pal,"
"0","    values = c(Comunas_ENP$ENP_2013, Comunas_ENP$ENP_2017, Comunas_ENP$ENP_2021),"
"0","    title  = ""ENP"","
"0","    opacity = 0.8"
"0","  )"
